<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de C贸digo de Barras</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 10px;
    background: #f4f4f4;
}

h2 {
    text-align: center;
}

#camera {
    width: 100%;
    max-width: 500px;
    height: 400px;
    margin: auto;
    overflow: hidden;
    border-radius: 8px;
    background: black;
    display: none;
}

#camera video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

button {
    width: 100%;
    padding: 12px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
}

#lista, #barcodes {
    background: #fff;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
}

.codigo {
    padding: 6px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.remover {
    background: red;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    cursor: pointer;
}

svg {
    margin-bottom: 15px;
}
</style>
</head>
<body>

<h2> Scanner de C贸digo de Barras</h2>

<!-- ENTRADA MANUAL -->
<div style="display:flex; gap:5px;">
    <input
        id="inputCodigo"
        type="text"
        placeholder="Digite qualquer c贸digo"
        style="flex:1; padding:10px; font-size:16px;"
    >
    <button onclick="adicionarCodigoManual()">Adicionar</button>
</div>

<button id="btnCamera">Abrir c芒mera</button>
<button id="btnFlash">Ligar flash</button>

<div id="camera"></div>

<button onclick="limparLista()">Limpar lista</button>
<button onclick="gerarImagens()">Gerar imagens dos c贸digos</button>

<div id="lista">
    <h3>C贸digos adicionados:</h3>
    <div id="codigos"></div>
</div>

<div id="barcodes">
    <h3>Imagens dos c贸digos:</h3>
</div>

<script>
let codigosLidos = [];
let scannerAtivo = false;
let stream = null;
let track = null;
let flashAtivo = false;
let detector = null;
let scanInterval = null;

/* =========================
   VIDEO
========================= */
const video = document.createElement("video");
video.setAttribute("playsinline", true);
video.muted = true;
video.autoplay = true;
document.getElementById("camera").appendChild(video);

/* =========================
   EAN-13 VALIDAO REAL
========================= */
function ean13Valido(codigo) {
    if (!/^\d{13}$/.test(codigo)) return false;

    let soma = 0;
    for (let i = 0; i < 12; i++) {
        const n = parseInt(codigo[i]);
        soma += (i % 2 === 0) ? n : n * 3;
    }

    const digito = (10 - (soma % 10)) % 10;
    return digito === parseInt(codigo[12]);
}

/* =========================
   ADICIONAR CDIGO (LIVRE)
========================= */
function adicionarCodigo(codigo) {
    if (!codigo) {
        alert("C贸digo vazio");
        return false;
    }

    if (codigosLidos.includes(codigo)) {
        alert("Este c贸digo j谩 foi adicionado.");
        return false;
    }

    codigosLidos.push(codigo);
    atualizarLista();
    return true;
}

function adicionarCodigoManual() {
    const input = document.getElementById("inputCodigo");
    const codigo = input.value.trim();
    if (adicionarCodigo(codigo)) input.value = "";
}

/* =========================
   SCANNER
========================= */
async function iniciarScanner() {
    if (scannerAtivo) return;

    if (!("BarcodeDetector" in window)) {
        alert("Seu navegador n茫o suporta leitura de c贸digo de barras.");
        return;
    }

    detector = new BarcodeDetector({
        formats: ["ean_13", "code_128"]
    });

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;
        await video.play();

        track = stream.getVideoTracks()[0];

        scannerAtivo = true;
        document.getElementById("camera").style.display = "block";
        document.getElementById("btnCamera").textContent = "Fechar c芒mera";

        scanInterval = setInterval(detectarCodigo, 600);
    } catch (err) {
        alert("Erro ao acessar a c芒mera");
    }
}

function pararScanner() {
    clearInterval(scanInterval);
    scanInterval = null;

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    scannerAtivo = false;
    document.getElementById("camera").style.display = "none";
    document.getElementById("btnCamera").textContent = "Abrir c芒mera";

    if (flashAtivo) toggleFlash();
}

async function detectarCodigo() {
    if (!detector || !scannerAtivo) return;

    const barcodes = await detector.detect(video);
    for (const barcode of barcodes) {
        if (adicionarCodigo(barcode.rawValue)) {
            pararScanner();
            break;
        }
    }
}

/* =========================
   FLASH
========================= */
async function toggleFlash() {
    if (!track) {
        alert("Flash n茫o suportado");
        return;
    }

    flashAtivo = !flashAtivo;
    try {
        await track.applyConstraints({
            advanced: [{ torch: flashAtivo }]
        });

        document.getElementById("btnFlash").textContent =
            flashAtivo ? "Desligar flash" : "Ligar flash";
    } catch {
        alert("Falha ao ativar flash");
        flashAtivo = false;
    }
}

/* =========================
   LISTA
========================= */
function atualizarLista() {
    const div = document.getElementById("codigos");
    div.innerHTML = "";

    codigosLidos.forEach((codigo, index) => {
        const item = document.createElement("div");
        item.className = "codigo";

        const texto = document.createElement("span");
        texto.textContent = codigo;

        const btn = document.createElement("button");
        btn.textContent = "";
        btn.className = "remover";
        btn.onclick = () => removerCodigo(index);

        item.appendChild(texto);
        item.appendChild(btn);
        div.appendChild(item);
    });
}

function removerCodigo(index) {
    codigosLidos.splice(index, 1);
    atualizarLista();
}

/* =========================
   LIMPAR
========================= */
function limparLista() {
    codigosLidos = [];
    document.getElementById("codigos").innerHTML = "";
    document.getElementById("barcodes").innerHTML =
        "<h3>Imagens dos c贸digos:</h3>";
}

/* =========================
   GERAR IMAGENS
========================= */
function gerarImagens() {
    const container = document.getElementById("barcodes");
    container.innerHTML = "<h3>Imagens dos c贸digos:</h3>";

    codigosLidos.forEach(codigo => {
        const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
        );
        container.appendChild(svg);

        const formato = ean13Valido(codigo) ? "ean13" : "code128";

        JsBarcode(svg, codigo, {
            format: formato,
            width: 2,
            height: 80,
            displayValue: true
        });
    });
}

/* =========================
   BOTES
========================= */
document.getElementById("btnCamera").onclick = () =>
    scannerAtivo ? pararScanner() : iniciarScanner();

document.getElementById("btnFlash").onclick = toggleFlash;
</script>

</body>
</html>
