<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de C√≥digo de Barras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QuaggaJS (iOS) -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 10px;
}
h2 { text-align: center; }

#camera {
    display: none;
    width: 100%;
    max-width: 500px;
    height: 350px;
    margin: auto;
    background: black;
    border-radius: 8px;
    overflow: hidden;
}

button, input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-top: 8px;
}

#lista, #barcodes {
    background: #fff;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
}

.codigo {
    display: flex;
    justify-content: space-between;
    padding: 6px;
    border-bottom: 1px solid #ddd;
}

.remover {
    background: red;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
}

svg { margin-bottom: 15px; }
</style>
</head>

<body>

<h2>üì∑ Scanner de C√≥digo de Barras</h2>

<!-- Entrada manual -->
<div style="display:flex; gap:5px;">
    <input id="inputCodigo" placeholder="Digite qualquer c√≥digo">
    <button onclick="adicionarCodigoManual()">Adicionar</button>
</div>

<button id="btnCamera">Abrir c√¢mera</button>
<button id="btnFlash">Ligar flash</button>

<div id="camera"></div>

<button onclick="gerarImagens()">Gerar imagens</button>
<button onclick="limparLista()">Limpar lista</button>

<div id="lista">
    <h3>C√≥digos:</h3>
    <div id="codigos"></div>
</div>

<div id="barcodes">
    <h3>Imagens:</h3>
</div>

<script>
/* =========================
   VARI√ÅVEIS
========================= */
let codigos = [];
let usandoQuagga = false;
let scannerAtivo = false;
let detector = null;
let stream = null;
let track = null;
let scanInterval = null;
let flashAtivo = false;

/* =========================
   DETECTAR iOS
========================= */
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

/* =========================
   EAN-13 REAL
========================= */
function ean13Valido(codigo) {
    if (!/^\d{13}$/.test(codigo)) return false;
    let soma = 0;
    for (let i = 0; i < 12; i++) {
        soma += (i % 2 === 0) ? +codigo[i] : +codigo[i] * 3;
    }
    return (10 - (soma % 10)) % 10 === +codigo[12];
}

/* =========================
   LISTA
========================= */
function adicionarCodigo(codigo) {
    if (!codigo || codigos.includes(codigo)) return false;
    codigos.push(codigo);
    atualizarLista();
    return true;
}

function adicionarCodigoManual() {
    const input = document.getElementById("inputCodigo");
    if (adicionarCodigo(input.value.trim())) input.value = "";
}

function atualizarLista() {
    const div = document.getElementById("codigos");
    div.innerHTML = "";
    codigos.forEach((c, i) => {
        div.innerHTML += `
        <div class="codigo">
            <span>${c}</span>
            <button class="remover" onclick="removerCodigo(${i})">√ó</button>
        </div>`;
    });
}

function removerCodigo(i) {
    codigos.splice(i, 1);
    atualizarLista();
}

/* =========================
   GERAR IMAGENS
========================= */
function gerarImagens() {
    const div = document.getElementById("barcodes");
    div.innerHTML = "<h3>Imagens:</h3>";

    codigos.forEach(codigo => {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        div.appendChild(svg);

        JsBarcode(svg, codigo, {
            format: ean13Valido(codigo) ? "ean13" : "code128",
            width: 2,
            height: 80,
            displayValue: true
        });
    });
}

/* =========================
   LIMPAR
========================= */
function limparLista() {
    codigos = [];
    atualizarLista();
    document.getElementById("barcodes").innerHTML = "<h3>Imagens:</h3>";
}

/* =========================
   SCANNER H√çBRIDO
========================= */
function iniciarScanner() {
    if (scannerAtivo) return;

    document.getElementById("camera").style.display = "block";
    document.getElementById("btnCamera").textContent = "Fechar c√¢mera";
    scannerAtivo = true;

    if (isIOS) iniciarQuagga();
    else iniciarBarcodeDetector();
}

function pararScanner() {
    scannerAtivo = false;
    document.getElementById("camera").style.display = "none";
    document.getElementById("btnCamera").textContent = "Abrir c√¢mera";

    if (usandoQuagga) {
        Quagga.stop();
        usandoQuagga = false;
    }

    if (scanInterval) clearInterval(scanInterval);

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
}

/* =========================
   ANDROID ‚Üí BarcodeDetector
========================= */
async function iniciarBarcodeDetector() {
    if (!("BarcodeDetector" in window)) {
        alert("BarcodeDetector n√£o suportado");
        pararScanner();
        return;
    }

    const camera = document.getElementById("camera");
    camera.innerHTML = ""; // ‚Üê ISSO EVITA C√ÇMERA PRETA

    detector = new BarcodeDetector({ formats: ["ean_13", "code_128"] });

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });

    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.muted = true;
    video.playsInline = true;

    camera.appendChild(video);

    await video.play(); // ‚Üê ESSENCIAL

    track = stream.getVideoTracks()[0];

}


/* =========================
   iOS ‚Üí QuaggaJS
========================= */
function iniciarQuagga() {
    usandoQuagga = true;

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: { facingMode: "environment" }
        },
        decoder: {
            readers: ["ean_reader", "code_128_reader"]
        }
    }, err => {
        if (err) {
            alert("Erro ao iniciar c√¢mera");
            pararScanner();
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(data => {
        if (adicionarCodigo(data.codeResult.code)) {
            pararScanner();
        }
    });
}

/* =========================
   FLASH
========================= */
async function toggleFlash() {
    if (!track) return alert("Flash n√£o suportado");
    flashAtivo = !flashAtivo;
    try {
        await track.applyConstraints({ advanced: [{ torch: flashAtivo }] });
        document.getElementById("btnFlash").textContent =
            flashAtivo ? "Desligar flash" : "Ligar flash";
    } catch {
        alert("Flash indispon√≠vel");
        flashAtivo = false;
    }
}

/* =========================
   BOT√ïES
========================= */
document.getElementById("btnCamera").onclick =
    () => scannerAtivo ? pararScanner() : iniciarScanner();

document.getElementById("btnFlash").onclick = toggleFlash;
</script>

</body>
</html>
