<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Scanner de Código de Barras Melhorado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 10px; background: #f4f4f4; }
h2 { text-align: center; }

#camera {
    width: 100%;
    max-width: 500px;
    height: 400px;
    margin: auto;
    overflow: hidden;
    border-radius: 8px;
    background: black;
    display: none;
}
#camera video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

button {
    width: 100%;
    padding: 12px;
    margin-top: 8px;
    font-size: 16px;
    cursor: pointer;
}

#lista, #barcodes {
    background: #fff;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
}

.codigo { padding: 5px; border-bottom: 1px solid #ddd; }
svg { margin-bottom: 15px; }
</style>
</head>
<body>

<h2>Scanner de Código de Barras Melhorado</h2>

<button id="btnCamera">Abrir câmera</button>
<button id="btnFlash">Ligar flash</button>

<div id="camera"></div>

<button onclick="limparLista()">Limpar lista de códigos</button>
<button onclick="gerarImagens()">Gerar imagens dos códigos</button>

<div id="lista">
    <h3>Códigos escaneados:</h3>
    <div id="codigos"></div>
</div>

<div id="barcodes">
    <h3>Imagens dos códigos:</h3>
</div>

<script>
let codigosLidos = [];
let scannerAtivo = false;
let streamTrack = null;
let flashAtivo = false;

// Iniciar scanner
function iniciarScanner() {
    if (scannerAtivo) return;

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector('#camera'),
            constraints: { facingMode: "environment" }
        },
        locator: {
            patchSize: "large",
            halfSample: true
        },
        decoder: {
            readers: [
                "ean_reader",
                "ean_8_reader",
                "upc_reader",
                "upc_e_reader",
                "code_128_reader",
                "code_39_reader"
            ]
        },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency || 4
    }, function(err) {
        if (err) {
            console.error(err);
            alert("Erro ao acessar a câmera");
            return;
        }
        Quagga.start();
        scannerAtivo = true;
        document.getElementById("camera").style.display = "block";
        document.getElementById("btnCamera").textContent = "Fechar câmera";

        // Pega a track de vídeo para ativar o flash
        const tracks = Quagga.CameraAccess.getActiveTrack() ? [Quagga.CameraAccess.getActiveTrack()] : [];
        if (tracks.length > 0) streamTrack = tracks[0];
    });
}

// Parar scanner
function pararScanner() {
    if (!scannerAtivo) return;
    Quagga.stop();
    scannerAtivo = false;
    document.getElementById("camera").style.display = "none";
    document.getElementById("btnCamera").textContent = "Abrir câmera";

    if (flashAtivo) toggleFlash(); // desliga flash ao fechar
}

// Alternar flash
async function toggleFlash() {
    if (!streamTrack) { alert("Flash não suportado neste dispositivo"); return; }
    try {
        flashAtivo = !flashAtivo;
        await streamTrack.applyConstraints({ advanced: [{ torch: flashAtivo }] });
        document.getElementById("btnFlash").textContent = flashAtivo ? "Desligar flash" : "Ligar flash";
    } catch (e) {
        alert("Não foi possível ativar o flash");
        flashAtivo = false;
        document.getElementById("btnFlash").textContent = "Ligar flash";
    }
}

// Detectar código
Quagga.onDetected(function(data) {
    const codigo = data.codeResult.code;
    if (!codigosLidos.includes(codigo)) {
        codigosLidos.push(codigo);
        atualizarLista();
        pararScanner(); // fecha câmera ao detectar
    }
});

// Atualizar lista
function atualizarLista() {
    const div = document.getElementById("codigos");
    div.innerHTML = "";
    codigosLidos.forEach(c => {
        const item = document.createElement("div");
        item.className = "codigo";
        item.textContent = c;
        div.appendChild(item);
    });
}

// Limpar lista
function limparLista() {
    codigosLidos = [];
    document.getElementById("codigos").innerHTML = "";
    document.getElementById("barcodes").innerHTML = "<h3>Imagens dos códigos:</h3>";
}

// Gerar imagens
function gerarImagens() {
    const container = document.getElementById("barcodes");
    container.innerHTML = "<h3>Imagens dos códigos:</h3>";

    codigosLidos.forEach((codigo, index) => {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = "barcode" + index;
        container.appendChild(svg);

        JsBarcode(svg, codigo, {
            format: codigo.length === 13 ? "ean13" : "code128",
            width: 2,
            height: 80,
            displayValue: true
        });
    });
}

// Botões
document.getElementById("btnCamera").addEventListener("click", () => {
    if (scannerAtivo) pararScanner();
    else iniciarScanner();
});

document.getElementById("btnFlash").addEventListener("click", toggleFlash);
</script>

</body>
</html>
