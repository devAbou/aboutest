<script>
let codigosLidos = [];
let scannerAtivo = false;
let stream = null;
let track = null;
let flashAtivo = false;
let detector = null;
let scanInterval = null;

const video = document.createElement("video");
video.setAttribute("playsinline", true);
video.style.width = "100%";
video.style.height = "100%";
video.style.objectFit = "cover";
document.getElementById("camera").appendChild(video);

// Iniciar scanner
async function iniciarScanner() {
    if (scannerAtivo) return;

    if (!("BarcodeDetector" in window)) {
        alert("Seu navegador não suporta leitura de código de barras.");
        return;
    }

    detector = new BarcodeDetector({
        formats: [
            "ean_13",
            "ean_8",
            "upc_a",
            "upc_e",
            "code_128",
            "code_39"
        ]
    });

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;
        await video.play();

        track = stream.getVideoTracks()[0];

        scannerAtivo = true;
        document.getElementById("camera").style.display = "block";
        document.getElementById("btnCamera").textContent = "Fechar câmera";

        scanInterval = setInterval(detectarCodigo, 600);

    } catch (err) {
        alert("Erro ao acessar a câmera");
        console.error(err);
    }
}

// Parar scanner
function pararScanner() {
    if (!scannerAtivo) return;

    clearInterval(scanInterval);
    scanInterval = null;

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    scannerAtivo = false;
    document.getElementById("camera").style.display = "none";
    document.getElementById("btnCamera").textContent = "Abrir câmera";

    if (flashAtivo) toggleFlash();
}

// Detectar código
async function detectarCodigo() {
    if (!detector || !scannerAtivo) return;

    try {
        const barcodes = await detector.detect(video);

        for (const barcode of barcodes) {
            const codigo = barcode.rawValue;

            if (!codigosLidos.includes(codigo)) {
                codigosLidos.push(codigo);
                atualizarLista();
                pararScanner();
                break;
            }
        }
    } catch (err) {
        console.error(err);
    }
}

// Flash
async function toggleFlash() {
    if (!track) {
        alert("Flash não suportado neste dispositivo");
        return;
    }

    try {
        flashAtivo = !flashAtivo;
        await track.applyConstraints({
            advanced: [{ torch: flashAtivo }]
        });

        document.getElementById("btnFlash").textContent =
            flashAtivo ? "Desligar flash" : "Ligar flash";
    } catch {
        alert("Não foi possível ativar o flash");
        flashAtivo = false;
    }
}

// Atualizar lista
function atualizarLista() {
    const div = document.getElementById("codigos");
    div.innerHTML = "";

    codigosLidos.forEach((codigo, index) => {
        const item = document.createElement("div");
        item.className = "codigo";

        const texto = document.createElement("span");
        texto.textContent = codigo;

        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.className = "remover";
        btn.onclick = () => removerCodigo(index);

        item.appendChild(texto);
        item.appendChild(btn);
        div.appendChild(item);
    });

    gerarImagens();
}

// Remover código
function removerCodigo(index) {
    codigosLidos.splice(index, 1);
    atualizarLista();
}

// Limpar lista
function limparLista() {
    codigosLidos = [];
    document.getElementById("codigos").innerHTML = "";
    document.getElementById("barcodes").innerHTML =
        "<h3>Imagens dos códigos:</h3>";
}

// Gerar imagens
function gerarImagens() {
    const container = document.getElementById("barcodes");
    container.innerHTML = "<h3>Imagens dos códigos:</h3>";

    codigosLidos.forEach(codigo => {
        const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
        );
        container.appendChild(svg);

        JsBarcode(svg, codigo, {
            format: codigo.length === 13 ? "ean13" : "code128",
            width: 2,
            height: 80,
            displayValue: true
        });
    });
}

// Botões
document.getElementById("btnCamera").onclick = () => {
    scannerAtivo ? pararScanner() : iniciarScanner();
};

document.getElementById("btnFlash").onclick = toggleFlash;
</script>
